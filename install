#! /bin/bash -xe

dir=$(realpath "$0" | sed 's/\/[^/]*$//')

ln -fs $dir/post-receive.to-systemd /usr/bin/

mkdir -p /srv

git config --global receive.denyCurrentBranch ignore   # so we can push to a working repo

templatedir=/usr/share/prts/repo-template.git
curr_templatedir=$(git config --global init.templatedir)

hook=/usr/bin/post-receive.to-systemd

if [ -z $curr_templatedir ]; then
  echo "Git does not have an init.templatedir, setting $templatedir."
  git config --global init.templatedir $templatedir
else
  if [[ "$curr_templatedir" == "$templatedir" ]]; then
		exit
  fi

  if [[ ! -e $curr_templatedir/hooks/post-receive ]]; then
		mkdir -p $curr_templatedir/hooks/
		cp $templatedir/hooks/post-receive $curr_templatedir/hooks/
  else
		echo "" >>  $curr_templatedir/hooks/post-receive
		echo "$hook" >> $curr_templatedir/hooks/post-receive
  fi
fi

echo
echo "Don't forget to put your public ssh key is in /home/git/.ssh/authorized_keys!"
echo
